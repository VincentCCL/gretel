/**
 * jQuery "plug-in" (not really) to convert an XML tree structure into a
 * plug-and-play HTML tree containing all original data.
 *
 * @version 0.1
 * @license MIT
 * @author Bram Vanroy
 */
function buildTVFrame(){FS=$("#fs-tree-visualizer"),SS=$("#tree-visualizer");var t='<div class="tree base"></div><aside class="tooltip" style="display: none"><ul></ul><button>&#10005;</button></aside><button class="expand">Fullscreen</button><div class="error" style="display: none"><p></p></div>';SS.append(t);var e='<div class="tree expanded size0"></div><aside class="tooltip" style="display: none"><ul></ul><button>&#10005;</button></aside><div class="zoom-opts"><button class="zoom-out">-</button><button class="zoom-default">Default</button><button class="zoom-in">+</button><button class="close">&#10005;</button></div>';FS.hide().append(e),treeFS=FS.find(".tree"),treeSS=SS.find(".tree"),tooltipFS=FS.find(".tooltip"),tooltipSS=SS.find(".tooltip"),anyTree=treeFS.add(treeSS),anyTooltip=tooltipFS.add(tooltipSS),zoomOpts=FS.find(".zoom-opts")}function treeVisualizer(t){$.ajax({type:"GET",url:t,dataType:"xml"}).done(function(t){null==t?errorHandle("Your XML is empty. Please try again later."):parseXMLObj(t)}).fail(function(t,e,o){errorHandle(e)})}function parseXMLObj(t){var e=$(t);removeError(),treeSS.html(buildOutputList(e.find("node").first())),anyTooltip.children("ul").empty(),treeFS.empty(),treeSS.children("ol").clone().appendTo(treeFS),treeModifier()}function buildOutputList(t){var e=$("<ol/>");return t.each(function(t,o){for(var n=$('<li><a href="#">&nbsp;</a></li>'),i=0,r=o.attributes.length,a=null;r>i;i++)a=o.attributes[i],n.attr("data-"+a.nodeName,a.value.replace(/^\s(.+)/g,"$1")),("cat"==a.nodeName||"word"==a.nodeName)&&n.html('<a href="#">'+a.value+"</a>");$(this).children("node").length&&n.append(buildOutputList($(this).children("node"))),e.append(n)}),e}function treeModifier(){anyTree.find("a:only-child").each(function(){var t=$(this),e=t.parent("li");0===t.next().length&&"&nbsp;"===t.html()?e.data("rel")&&t.html("<em>"+e.data("rel")+"</em>"):e.data("rel")&&e.append("<span><em>"+e.data("rel")+"</em></span>"),e.data("pt")&&e.append("<span>"+e.data("pt")+"</span>"),e.data("lemma")&&e.append("<span>"+e.data("lemma")+"</span>"),t.addClass("only-child")})}function noMoreZooming(){zoomCounter>2?zoomOpts.find("button.zoom-in").prop("disabled",!0):-3>zoomCounter?zoomOpts.find("button.zoom-out").prop("disabled",!0):zoomOpts.find("button").prop("disabled",!1)}function treeInvestigator(){treeFS.attr("class",treeFS.attr("class").replace(/(size)-?\d/,"$1"+zoomCounter))}function tooltipPosition(){var t=treeSS;treeFS.is(":visible")&&(t=treeFS);var e=t.find("a.hovered");if(e.length){var o=t.next(".tooltip"),n=e[0].getBoundingClientRect().top,i=e[0].getBoundingClientRect().left;o.css({left:parseInt(i+e.outerWidth()/2-o.outerWidth()/2+7.5,10),top:parseInt(n-o.outerHeight()-24,10)})}}function setSizeTreeFS(){var t=parseInt(treeFS.css("paddingRight"),10)||0,e=parseInt(treeFS.css("paddingTop"),10)||0,o=parseInt(FS.css("paddingRight"),10)||0,n=parseInt(FS.css("paddingTop"),10)||0,i=treeFS.children("ol"),r=$(window);treeFS.css({width:i.outerWidth()+2*t,height:i.outerHeight()+2*e,"max-width":r.width()-2*o,"max-height":r.height()-2*n}),treeFS.css({"margin-left":(r.width()-2*o-treeFS.outerWidth())/2,"margin-top":(r.height()-2*n-treeFS.outerHeight())/2})}function errorHandle(t){SS.find(".error > p").text(t).closest(".error").fadeIn(250),treeSS.scrollLeft(0),SS.find(".expand").prop("disabled",!0)}function removeError(){SS.find(".error").hide(),SS.find(".expand").prop("disabled",!1)}var zoomCounter=0,FS,SS,treeFS,treeSS,tooltipFS,tooltipSS,anyTree,anyTooltip,zoomOpts;$(document).ready(function(){buildTVFrame(),SS.find(".expand").click(function(){anyTooltip.css("top","-100%").children("ul").empty(),zoomCounter=0,noMoreZooming(),treeInvestigator(),FS.fadeIn(250),setSizeTreeFS()}),anyTree.scroll(function(){$(this).next(".tooltip").is(":visible")&&tooltipPosition()}),$(window).scroll(function(){tooltipPosition()}),zoomOpts.find("button").click(function(){var t=$(this);t.is(".close")?FS.fadeOut(250,function(){treeFS.find("a").removeClass("hovered")}):(t.is(".zoom-in")?zoomCounter++:t.is(".zoom-out")?zoomCounter--:t.is(".zoom-default")&&(zoomCounter=0),noMoreZooming(),treeInvestigator(),setSizeTreeFS(),tooltipPosition())}),anyTree.on("click","a",function(t){var e=$(this),o=e.parent("li"),n=o.data(),i=e.closest(".tree"),r=i.find("a"),a=i.next(".tooltip").children("ul");a.empty(),r.removeClass("hovered"),e.addClass("hovered");var s;for(s in n)n.hasOwnProperty(s)&&$("<li>",{html:"<strong>"+s+"</strong>: "+n[s]}).prependTo(a);tooltipPosition(),i.next(".tooltip").show(),t.preventDefault()}),anyTooltip.find("button").click(function(){var t=$(this),e=t.parent(".tooltip"),o=e.prev(".tree"),n=o.find("a");e.fadeOut(250),n.removeClass("hovered")}),window.onresize=setSizeTreeFS});
